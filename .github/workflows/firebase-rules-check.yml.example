# Exemple de workflow GitHub Actions pour valider les r√®gles Firebase
# √Ä activer en cr√©ant le fichier .github/workflows/firebase-rules-check.yml

name: Firebase Rules Validation

on:
  pull_request:
    paths:
      - 'firestore.rules'
      - 'storage.rules'
      - 'firebase.json'

  push:
    branches:
      - main
      - develop
    paths:
      - 'firestore.rules'
      - 'storage.rules'

jobs:
  validate-rules:
    name: Validate Firebase Security Rules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Validate Firestore Rules Syntax
        run: |
          # V√©rifier que le fichier existe
          if [ ! -f "firestore.rules" ]; then
            echo "‚ùå firestore.rules not found"
            exit 1
          fi

          # Validation syntaxe (dry-run)
          firebase deploy --only firestore:rules --dry-run --project apprenti-geometre || {
            echo "‚ùå Firestore rules validation failed"
            exit 1
          }

          echo "‚úÖ Firestore rules syntax valid"

      - name: Validate Storage Rules Syntax
        run: |
          # V√©rifier que le fichier existe
          if [ ! -f "storage.rules" ]; then
            echo "‚ùå storage.rules not found"
            exit 1
          fi

          # Validation syntaxe (dry-run)
          firebase deploy --only storage:rules --dry-run --project apprenti-geometre || {
            echo "‚ùå Storage rules validation failed"
            exit 1
          }

          echo "‚úÖ Storage rules syntax valid"

      - name: Check Rules Best Practices
        run: |
          echo "üîç Checking security best practices..."

          # V√©rifier qu'il n'y a pas de allow read, write: if true sur toutes les collections
          if grep -q "allow read, write: if true" firestore.rules; then
            echo "‚ö†Ô∏è  WARNING: Found 'allow read, write: if true' - this is insecure!"
            echo "Please review your rules for security."
          fi

          # V√©rifier la pr√©sence de validation de taille
          if ! grep -q "size()" firestore.rules; then
            echo "‚ö†Ô∏è  WARNING: No size validation found in Firestore rules"
          fi

          # V√©rifier la pr√©sence de la r√®gle de protection par d√©faut
          if ! grep -q "match /{document=\*\*}" firestore.rules; then
            echo "‚ö†Ô∏è  WARNING: No default deny rule found"
          fi

          echo "‚úÖ Best practices check completed"

      - name: Comment PR with validation results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ Firebase Security Rules validation passed!\n\n**Modified files:**\n- `firestore.rules`\n- `storage.rules`\n\n‚ö†Ô∏è **Important:** Before deploying, verify manually in Firebase Console that no rules were modified directly.'
            })

  # Job optionnel : d√©ploiement automatique sur merge dans main
  deploy-rules:
    name: Deploy Rules to Firebase (optional)
    runs-on: ubuntu-latest
    needs: validate-rules
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    # ‚ö†Ô∏è D√©commenter seulement si vous voulez un d√©ploiement automatique
    # N√©cessite : secrets.FIREBASE_TOKEN configur√© dans GitHub

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      # D√©commenter pour activer le d√©ploiement automatique
      # - name: Deploy Rules
      #   env:
      #     FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      #   run: |
      #     firebase deploy --only firestore:rules,storage:rules --project apprenti-geometre --token "$FIREBASE_TOKEN"

      - name: Manual Deploy Notice
        run: |
          echo "‚ö†Ô∏è  Automatic deployment is disabled by default"
          echo "To deploy manually:"
          echo "  npm run deploy:rules"

# Configuration requise dans GitHub :
#
# 1. Cr√©er un token Firebase :
#    firebase login:ci
#
# 2. Ajouter le token comme secret GitHub :
#    Repository Settings ‚Üí Secrets ‚Üí New secret
#    Name: FIREBASE_TOKEN
#    Value: [token g√©n√©r√©]
#
# 3. Activer les workflows dans les settings du repository
