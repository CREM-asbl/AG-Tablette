<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="div-main-canvas">
    <template>
        <style>
            canvas#mainCanvas {
                background-color: rgba(0,0,0,0);
                position: absolute;
                top: 0px;
            }
            canvas#backgroundCanvas {
                position: absolute;
                top: 0px;
            }
        </style>
        <canvas id="backgroundCanvas"></canvas>
        <canvas id="mainCanvas"></canvas>
    </template>
    <script>
        /**
         * Event handler du canvas
         */
        class DivMainCanvas extends Polymer.Element {

            static get is() { return 'div-main-canvas' }

            /**
             * Défini les attributs width and height du <canvas>. Doit être appelé au démarrage et lorsque la page est redimensionnée.
             */
            setCanvasSize() {
                var cvs = this.$.mainCanvas;
                cvs.setAttribute("height", this.parentElement.clientHeight);
                cvs.setAttribute("width", this.parentElement.clientWidth*0.7);
                var backgroundCvs = this.$.backgroundCanvas;
                backgroundCvs.setAttribute("height", this.parentElement.clientHeight);
                backgroundCvs.setAttribute("width", this.parentElement.clientWidth*0.7);
            }

            /**
             * Récupère les coordonnées de la souris à partir d'un événement javascript
             * @param event: référence vers l'événement (Event)
             * @return coordonnées de la souris ({x: int, y: int})
             * @Error: si les coordonnées n'ont pas été trouvées, une alerte (alert()) est déclanchée et la fonction retourne null
             */
            getMousePos(event, appRef) {
                var response = null;
                if(event.offsetX!==undefined) {
                    response = [event.offsetX, event.offsetY];
                } else if(event.layerX!==undefined) {
                    response = [event.layerX, event.layerY];
                } else if(event.clientX!==undefined) {
                    response = [event.clientX, event.clientY];
                } else if(event.pageX!==undefined) {
                    response = [event.pageX, event.pageY];
                } else if(event.x!==undefined) {
                    response = [event.x, event.y];
                } else if(event.changedTouches && event.changedTouches[0] && event.changedTouches[0].clientX!==undefined) {
                    response = [event.changedTouches[0].clientX - window.canvasLeftShift, event.changedTouches[0].clientY];
                } else {
                    alert("navigator not compatible");
                    var str = event.type;
                    for (var property1 in event) {
                        str+= " | "+property1+" : "+ event[property1];
                    }
                    alert(str);

                    if(event.touches) {
                        str = "touches: "+event.touches.length+"";
                        for (var property1 in event["touches"][0]) {
                            str+= " | "+property1+" : "+ ["touches"][0][property1];
                        }
                        alert(str);
                    }
                    return null;
                }

                return {"x": response[0] / appRef.workspace.zoomLevel, "y": response[1] / appRef.workspace.zoomLevel};
            }

            /**
             * Défini les event-handlers du <canvas>
             */
            ready() {
                super.ready();

                this.setCanvasSize();
                var cvs = this.$.mainCanvas;
                var that = this;

                cvs.addEventListener('click', function(event){
                    window.app.handleEvent("click", that.getMousePos(event, window.app));
                }, false);

                cvs.addEventListener('mousedown', function(event){
                    window.app.handleEvent("mousedown", that.getMousePos(event, window.app));
                }, false);

                cvs.addEventListener('mouseup', function(event){
                    window.app.handleEvent("mouseup", that.getMousePos(event, window.app));
                }, false);

                cvs.addEventListener('mousemove', this._handleMove.bind(this), false);

                //Tablette:
                cvs.addEventListener('touchstart', function(event){
                    if(event.touches.length > 1)
                        return;
                    event.preventDefault();
                    window.app.handleEvent("mousedown", that.getMousePos(event, window.app));
                }, false);

                cvs.addEventListener('touchmove', function(event){
                    event.preventDefault();
                    that._handleMove(event);
                }, false);

                cvs.addEventListener('touchend', function(event){
                    var pos = that.getMousePos(event, window.app);
                    window.app.handleEvent("mouseup", pos);
                    window.app.handleEvent("click", pos);
                }, false);

                cvs.addEventListener('touchleave', function(event){
                    var pos = that.getMousePos(event, window.app);
                    window.app.handleEvent("mouseup", pos);
                    window.app.handleEvent("click", pos);
                }, false);

                cvs.addEventListener("touchcancel", function(event){
                    event.preventDefault();
                    window.app.handleEvent("mouseup", that.getMousePos(event, window.app));
                }, false);



                //TODO?
                //cvs.addEventListener("touchcancel", handleCancel, false);
            }

            /**
             * Appelée lorsque l'événement mousemove est déclanché sur le canvas
             */
            _handleMove(event) {
                window.app.canvas.refresh(this.getMousePos(event, window.app), {'event_type': 'mousemove'});
            }

        }
        customElements.define(DivMainCanvas.is, DivMainCanvas);
    </script>
</dom-module>
