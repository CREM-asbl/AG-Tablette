<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="div-main-canvas">
    <template>
        <style>
            canvas {
                background-color: white;
            }
        </style>
        <canvas id="mainCanvas"></canvas>
    </template>
    <script>
        /**
         * Event handler du canvas
         */
        class DivMainCanvas extends Polymer.Element {

            static get is() { return 'div-main-canvas' }

            /**
             * Défini les attributs width and height du <canvas>. Doit être appelé au démarrage et lorsque la page est redimensionnée.
             */
            setCanvasSize() {
                var cvs = this.$.mainCanvas;
                cvs.setAttribute("height", this.parentElement.clientHeight);
                cvs.setAttribute("width", this.parentElement.clientWidth*0.7);
            }

            /**
             * Récupère les coordonnées de la souris à partir d'un événement javascript
             * @param event: référence vers l'événement (Event)
             * @return coordonnées de la souris ({x: int, y: int})
             * @Error: si les coordonnées n'ont pas été trouvées, une alerte (alert()) est déclanchée et la fonction retourne null
             */
            getMousePos(event, appRef) {
                var response = null;
                if(event.offsetX!==undefined) {
                    response = [event.offsetX, event.offsetY];
                } else if(event.layerX!==undefined) {
                    response = [event.layerX, event.layerY];
                } else if(event.clientX!==undefined) {
                    response = [event.clientX, event.clientY];
                } else if(event.pageX!==undefined) {
                    response = [event.pageX, event.pageY];
                } else if(event.x!==undefined) {
                    response = [event.x, event.y];
                } else {
                    alert("navigator not compatible");
                    return null;
                }

                return {"x": response[0] / appRef.workspace.zoomLevel, "y": response[1] / appRef.workspace.zoomLevel};
            }

            /**
             * Défini les event-handlers du <canvas>
             */
            ready() {
                super.ready();

                this.setCanvasSize();
                var cvs = this.$.mainCanvas;
                var that = this;

                cvs.addEventListener('click', function(event){
                    window.app.handleEvent("click", that.getMousePos(event, window.app));
                }, false);

                cvs.addEventListener('mousedown', function(event){
                    window.app.handleEvent("mousedown", that.getMousePos(event, window.app));
                }, false);

                cvs.addEventListener('mouseup', function(event){
                    window.app.handleEvent("mouseup", that.getMousePos(event, window.app));
                }, false);

                cvs.addEventListener('mousemove', this._handleMove.bind(this), false);
                //cvs.addEventListener('touchmove', this._handleTouch.bind(this), false);
                //cvs.addEventListener("touchstart", this._handleStart.bind(this), false);
                //cvs.addEventListener("touchend", this._handleEnd.bind(this), false);
                //cvs.addEventListener("touchcancel", handleCancel, false);
                //cvs.addEventListener("touchleave", handleLeave, false);
            }

            /**
             * Appelée lorsque l'événement mousemove est déclanché sur le canvas
             */
            _handleMove(event) {
                window.app.canvas.refresh(this.getMousePos(event, window.app));
            }

        }
        customElements.define(DivMainCanvas.is, DivMainCanvas);
    </script>
</dom-module>
