<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="div-main-canvas">
    <template>
        <style>
            canvas {
                background-color: white;
            }
        </style>
        <canvas id="mainCanvas"></canvas>
    </template>
    <script>
        /**
         * Canvas event handler
         */
        class DivMainCanvas extends Polymer.Element {

            static get is() { return 'div-main-canvas' }

            /**
             * Define the <canvas> width and height attributes. Must be called on page load and when the page is resized.
             */
            setCanvasSize() {
                var cvs = this.$.mainCanvas;
                //set canvas fixed size
                cvs.setAttribute("height", this.parentElement.clientHeight);
                cvs.setAttribute("width", this.parentElement.clientWidth*0.7);
            }

            /**
             * Get the mouse coordinates from an event reference
             * @param event: event reference (Event)
             * @return mouse coordinates ({x: int, y: int})
             * @Error: if the coordinates were not found, an alert() is triggered and the function returns null
             */
            getMousePos(event, appRef) {
                var response = null;
                if(event.offsetX!==undefined) {
                    response = [event.offsetX, event.offsetY];
                } else if(event.layerX!==undefined) {
                    response = [event.layerX, event.layerY];
                } else if(event.clientX!==undefined) {
                    response = [event.clientX, event.clientY];
                } else if(event.pageX!==undefined) {
                    response = [event.pageX, event.pageY];
                } else if(event.x!==undefined) {
                    response = [event.x, event.y];
                } else {
                    alert("navigator not compatible");
                    return null;
                }

                return {"x": response[0] / appRef.workspace.zoomLevel, "y": response[1] / appRef.workspace.zoomLevel};
            }

            /**
             * Set the <canvas> events handlers
             */
            ready() {
                super.ready();

                this.setCanvasSize();
                var cvs = this.$.mainCanvas;
                var that = this;

                //cvs.addEventListener('click', this._handleClick.bind(this), false);
                cvs.addEventListener('click', function(event){
                    window.app.handleEvent("click", that.getMousePos(event, window.app));
                }, false);

                cvs.addEventListener('mousedown', function(event){
                    window.app.handleEvent("mousedown", that.getMousePos(event, window.app));
                }, false);

                cvs.addEventListener('mouseup', function(event){
                    window.app.handleEvent("mouseup", that.getMousePos(event, window.app));
                }, false);



                cvs.addEventListener('mousemove', this._handleMove.bind(this), false);

                cvs.addEventListener('touchmove', this._handleTouch.bind(this), false);
                // this.addEventListener("touchstart", this._handleStart.bind(this), false);
                cvs.addEventListener("touchend", this._handleEnd.bind(this), false);
                // addEventListener("touchcancel", handleCancel, false);
                // addEventListener("touchleave", handleLeave, false);
            }

            /**
             * <canvas> click event handler
             */
            _handleClick(event) {

            }

            /**
             * <canvas> mousemove event handler
             */
            _handleMove(event) {
                window.app.canvas.refresh(this.getMousePos(event, window.app));
            }

            /**
             * <canvas> ? event handler
             */
            _handleTouch(event) {
                console.log("handle touch");
            }

            /**
             * <canvas> ? event handler
             */
            _handleEnd() {
                console.log("handle end");
            }
        }
        customElements.define(DivMainCanvas.is, DivMainCanvas);
    </script>
</dom-module>
